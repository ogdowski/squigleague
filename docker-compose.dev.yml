# Development Docker Compose Override
# Builds images locally instead of pulling from registry
#
# Usage: docker-compose -f docker-compose.yml -f docker-compose.dev.yml up -d

services:
  backend:
    # Build locally for development
    build:
      context: ./backend
      dockerfile: Dockerfile

    # Hot reload: mount source code and enable uvicorn reload
    volumes:
      - ./backend/app:/app/app:ro
      - ./backend/migrations:/app/migrations
    command: ["sh", "-c", "alembic upgrade head && uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload"]

    # Development-specific settings
    restart: unless-stopped

    # Verbose logging for development
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

  frontend:
    # Use node image directly for Vite dev server with HMR
    image: node:20-alpine
    working_dir: /app

    # Hot reload: mount source code and run Vite dev server
    volumes:
      - ./frontend:/app
      - frontend_node_modules:/app/node_modules
    command: sh -c "npm install && npm run dev -- --host 0.0.0.0"

    # Development-specific settings
    restart: unless-stopped

    # Verbose logging for development
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

  nginx:
    # Build locally for development
    build:
      context: ./nginx
      dockerfile: Dockerfile

    # Override with dev config (Vite HMR support)
    volumes:
      - ./nginx/nginx.dev.conf:/etc/nginx/nginx.conf:ro

volumes:
  frontend_node_modules:
