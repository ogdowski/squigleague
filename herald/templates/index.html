{% extends "base.html" %}

{% block content %}
<div class="max-w-4xl mx-auto mt-6 sm:mt-10 px-4 sm:px-6 pb-8">

    <!-- Hero Section -->
    <div class="text-center mb-8 sm:mb-12">
        <h1 class="text-3xl sm:text-4xl lg:text-5xl font-bold mb-3 sm:mb-4 text-accent-light">
            Herald
        </h1>
        <p class="text-lg sm:text-xl mb-2 text-text-accent-mid">
            Fair and Secure Army List Exchange
        </p>
    </div>

    <!-- Problem/Solution Section -->
    <div class="border-l-4 border-accent-light p-4 sm:p-6 mb-6 sm:mb-8 rounded-r-lg bg-bg-dark">
        <h2 class="text-xl sm:text-2xl font-bold mb-3 text-accent-light">
            Why Herald?
        </h2>
        <div class="text-sm sm:text-base space-y-3 text-text-primary">
            <p>
                <strong class="text-accent-mid">The Problem:</strong> In competitive Warhammer games, if one player
                sees their opponent's army list first, they can tailor their strategy and unit composition accordingly.
            </p>
            <p>
                <strong class="text-accent-mid">The Solution:</strong> Herald ensures both players commit simultaneously
                using cryptographic hashes. Neither can see the other's list until both are locked in, removing
                suspicion and proving fair play.
            </p>
        </div>
    </div>
    
    <!-- How It Works -->
    <div class="bg-bg-dark rounded-lg shadow-lg p-6 sm:p-8 mb-6 sm:mb-8 border border-bg-medium">
        <h2 class="text-xl sm:text-2xl font-bold mb-6 text-center text-accent-mid">
            How It Works
        </h2>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 sm:gap-8">
            <div class="text-center">
                <div class="bg-bg-medium w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 border-2 border-primary-light">
                    <span class="text-3xl font-bold">1</span>
                </div>
                <h3 class="font-semibold text-base sm:text-lg mb-2">Create Exchange</h3>
                <p class="text-sm text-text-secondary">
                    Paste your army list and get a unique link. Your list is locked with a cryptographic hash.
                </p>
            </div>

            <div class="text-center">
                <div class="bg-bg-medium w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 border-2 border-primary">
                    <span class="text-3xl font-bold">2</span>
                </div>
                <h3 class="font-semibold text-base sm:text-lg mb-2">Opponent Responds</h3>
                <p class="text-sm text-text-secondary">
                    Your opponent opens the link, sees proof your list exists (the hash), and submits theirs.
                </p>
            </div>

            <div class="text-center">
                <div class="bg-bg-medium w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 border-2 border-primary-dark">
                    <span class="text-3xl font-bold">3</span>
                </div>
                <h3 class="font-semibold text-base sm:text-lg mb-2">Lists Revealed</h3>
                <p class="text-sm text-text-secondary">
                    Both lists appear instantly. Hash verification proves neither was changed.
                </p>
            </div>
        </div>
    </div>
    
    <!-- Create Form -->
    <div class="bg-bg-dark rounded-lg shadow-lg p-4 sm:p-8 border border-bg-medium"
         x-data="createExchange()"
         x-cloak>
        <h2 class="text-xl sm:text-2xl font-bold mb-4 sm:mb-6 text-center text-accent-mid">
            Create an Exchange
        </h2>

        <form @submit.prevent="submitForm" class="space-y-4">
            <div>
                <label for="list-content" class="block text-sm font-medium mb-2 text-text-primary">
                    Paste Your Army List
                </label>
                <textarea
                    id="list-content"
                    x-model="listContent"
                    rows="10"
                    class="w-full px-3 sm:px-4 py-2 sm:py-3 border border-bg-medium rounded-lg focus:outline-none focus:ring-2 focus:ring-primary font-mono text-sm resize-y bg-bg-darker text-text-primary placeholder-text-muted"
                    :class="{ 'border-accent-mid': error }"
                    placeholder="Example:

Ooops All Rats! 2000/2000 pts

Skaven
Claw-horde
General's Handbook 2025-26
Drops: 2
Wounds: 220
Spell Lore - Lore of Ruin
Prayer Lore - Noxious Prayers
Manifestation Lore - Manifestations of Doom

Battle Tactic Cards: Scouting Force, Restless Energy

General's Regiment
Vizzik Skour, Prophet of the Horned Rat (380)
• General
Clanrats (300)
• Reinforced
Clanrats (300)
• Reinforced
Clanrats (300)
• Reinforced

Regiment 1
Grey Seer (120)
• Skavenbrew
• Scurry Away
Clanrats (300)
• Reinforced
Clanrats (300)
• Reinforced

Faction Terrain
Gnawhole


Created with Sigdex: sigdex.io
App Version: 15.0.8
Data Version: v37
"
                    required
                    maxlength="50000"
                    :disabled="loading"
                ></textarea>
                <div class="flex justify-between items-center mt-1">
                    <p class="text-xs text-text-muted">
                        Maximum 50,000 characters. Lists stored for 30 days only.
                    </p>
                    <p class="text-xs text-text-muted" x-show="listContent.length > 0">
                        <span x-text="listContent.length"></span> / 50,000
                    </p>
                </div>
            </div>

            <div x-show="error"
                 x-transition
                 class="bg-accent-mid bg-opacity-20 border border-accent-mid text-accent-light px-4 py-3 rounded">
                <p class="text-sm" x-text="error"></p>
            </div>

            <button
                type="submit"
                :disabled="loading || listContent.trim().length === 0"
                :class="loading ? 'bg-bg-primary cursor-not-allowed' : 'bg-primary hover:bg-primary-dark active:bg-primary-dark'"
                class="w-full text-bg-darkest font-semibold py-3 sm:py-4 px-4 sm:px-6 rounded-lg transition text-base sm:text-lg shadow-lg disabled:opacity-50"
            >
                <span x-show="!loading">Create Secure Exchange</span>
                <span x-show="loading" class="flex items-center justify-center gap-2">
                    <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Creating...
                </span>
            </button>
        </form>
    </div>
    
</div>

<script>
function createExchange() {
    return {
        listContent: '',
        loading: false,
        error: null,
        
        async submitForm() {
            this.error = null;
            
            if (!this.listContent.trim()) {
                this.error = 'Please enter your army list';
                return;
            }
            
            this.loading = true;
            
            try {
                const response = await fetch('/exchange/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ list_content: this.listContent })
                });
                
                if (response.status === 429) {
                    this.error = '⏱️ Rate limit exceeded. Please wait and try again.';
                    return;
                }
                
                if (!response.ok) {
                    throw new Error('Failed to create exchange');
                }
                
                const data = await response.json();
                window.location.href = data.url;
                
            } catch (err) {
                this.error = 'Error creating exchange. Please try again.';
                console.error(err);
            } finally {
                this.loading = false;
            }
        }
    }
}
</script>
{% endblock %}
