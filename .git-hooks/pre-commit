#!/bin/bash
# Pre-commit hook to format code and prevent committing sensitive files
# Install: cp .git-hooks/pre-commit .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit

RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

# Auto-format Python files with Black and isort
echo "üé® Auto-formatting Python files..."

# Get list of staged Python files in backend/
PYTHON_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '^backend/.*\.py$')

if [ ! -z "$PYTHON_FILES" ]; then
    # Try to find black and isort (check common locations)
    BLACK_CMD=""
    ISORT_CMD=""

    for cmd_path in "black" "$HOME/Library/Python/3.9/bin/black" "/usr/local/bin/black" "$HOME/.local/bin/black"; do
        if command -v "$cmd_path" &> /dev/null; then
            BLACK_CMD="$cmd_path"
            break
        fi
    done

    for cmd_path in "isort" "$HOME/Library/Python/3.9/bin/isort" "/usr/local/bin/isort" "$HOME/.local/bin/isort"; do
        if command -v "$cmd_path" &> /dev/null; then
            ISORT_CMD="$cmd_path"
            break
        fi
    done

    if [ ! -z "$BLACK_CMD" ] && [ ! -z "$ISORT_CMD" ]; then
        echo "Running Black and isort on: $PYTHON_FILES"
        $BLACK_CMD $PYTHON_FILES
        $ISORT_CMD $PYTHON_FILES

        # Re-stage the formatted files
        git add $PYTHON_FILES
        echo -e "${GREEN}‚úÖ Files formatted and re-staged${NC}"
    else
        echo -e "${YELLOW}‚ö†Ô∏è  Black/isort not found${NC}"
        echo "Install with: pip3 install --user black isort"
        echo "Or run manually after commit: just test"
        echo ""
        echo "Skipping auto-format..."
    fi
else
    echo "No Python files to format."
fi

echo ""
echo "üîç Checking for sensitive data..."

# Check for .env files (except .example)
if git diff --cached --name-only | grep -E '^\.env$|^\.env\.local$|^\.env\.prod$|backend/\.env$|frontend/\.env$'; then
    echo -e "${RED}‚ùå ERROR: Attempting to commit .env file!${NC}"
    echo "These files contain secrets and should NEVER be committed."
    echo "Only .env.*.example files should be in git."
    exit 1
fi

# Check for common secret patterns in staged content
SECRETS=$(git diff --cached --word-diff=porcelain | grep '^+' | grep -iE 'password.*=.{8,}|secret.*=.{20,}|api[_-]key.*=.{20,}|private[_-]key')
if [ ! -z "$SECRETS" ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  WARNING: Possible secrets detected in staged changes!${NC}"
    echo "Review the following lines:"
    echo "$SECRETS"
    echo ""
    read -p "Are you sure you want to commit? (yes/no): " confirm
    if [ "$confirm" != "yes" ]; then
        echo "Commit aborted."
        exit 1
    fi
fi

# Check for IP addresses (except examples and documentation)
IPS=$(git diff --cached | grep '^+' | grep -oE '\b([0-9]{1,3}\.){3}[0-9]{1,3}\b' | grep -v '127.0.0.1' | grep -v '0.0.0.0' | grep -v 'example')
if [ ! -z "$IPS" ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  WARNING: IP addresses detected in changes!${NC}"
    echo "Found IPs: $IPS"
    echo "Make sure these are not your actual VPS IPs."
    read -p "Continue with commit? (yes/no): " confirm
    if [ "$confirm" != "yes" ]; then
        echo "Commit aborted."
        exit 1
    fi
fi

echo "‚úÖ Security check passed!"
exit 0
