#!/bin/bash
# Pre-commit hook to prevent committing sensitive files
# Install: cp .git-hooks/pre-commit .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit

RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "üîç Checking for sensitive data..."

# Check for .env files (except .example)
if git diff --cached --name-only | grep -E '^\.env$|^\.env\.local$|^\.env\.prod$|backend/\.env$|frontend/\.env$'; then
    echo -e "${RED}‚ùå ERROR: Attempting to commit .env file!${NC}"
    echo "These files contain secrets and should NEVER be committed."
    echo "Only .env.*.example files should be in git."
    exit 1
fi

# Check for common secret patterns in staged content
SECRETS=$(git diff --cached --word-diff=porcelain | grep '^+' | grep -iE 'password.*=.{8,}|secret.*=.{20,}|api[_-]key.*=.{20,}|private[_-]key')
if [ ! -z "$SECRETS" ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  WARNING: Possible secrets detected in staged changes!${NC}"
    echo "Review the following lines:"
    echo "$SECRETS"
    echo ""
    read -p "Are you sure you want to commit? (yes/no): " confirm
    if [ "$confirm" != "yes" ]; then
        echo "Commit aborted."
        exit 1
    fi
fi

# Check for IP addresses (except examples and documentation)
IPS=$(git diff --cached | grep '^+' | grep -oE '\b([0-9]{1,3}\.){3}[0-9]{1,3}\b' | grep -v '127.0.0.1' | grep -v '0.0.0.0' | grep -v 'example')
if [ ! -z "$IPS" ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  WARNING: IP addresses detected in changes!${NC}"
    echo "Found IPs: $IPS"
    echo "Make sure these are not your actual VPS IPs."
    read -p "Continue with commit? (yes/no): " confirm
    if [ "$confirm" != "yes" ]; then
        echo "Commit aborted."
        exit 1
    fi
fi

echo "‚úÖ Security check passed!"
exit 0
